# Dockerfile para Stable Diffusion WebUI baseado em https://github.com/AbdBarho/stable-diffusion-webui-docker
FROM nvidia/cuda:12.2.0-base-ubuntu22.04

# Força o uso de HTTPS nos repositórios oficiais do Ubuntu
RUN sed -i 's|http://archive.ubuntu.com/ubuntu|https://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list
RUN sed -i 's|http://security.ubuntu.com/ubuntu|https://security.ubuntu.com/ubuntu|g' /etc/apt/sources.list

# Instala dependências básicas
RUN apt-get update && apt-get install -y \
    git \
    wget \
    python3 \
    python3-pip \
    python3-venv \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Cria diretório de trabalho
WORKDIR /app

# Clona o repositório AUTOMATIC1111/stable-diffusion-webui
RUN git clone --depth 1 https://github.com/AUTOMATIC1111/stable-diffusion-webui.git .

# Instala as dependências Python
RUN python3 -m venv venv && \
    . venv/bin/activate && \
    pip install --upgrade pip && \
    pip install -r requirements.txt

# Expõe a porta da WebUI
EXPOSE 7860

# Comando para iniciar a WebUI
CMD ["/app/venv/bin/python3", "launch.py", "--listen", "--port", "7860", "--api", "--xformers", "--medvram", "--enable-insecure-extension-access"] 